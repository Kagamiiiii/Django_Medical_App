<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/css/bootstrap-select.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>
  <script type="text/javascript"> window.CSRF_TOKEN = "{{ csrf_token }};" </script>
  <link rel="stylesheet" type="text/css" href="{% static '/css/createOrder.css' %}">
  <link rel="shortcut icon" href="#" />
  <title>Create Order</title>
</head>

<body>
  <header>
    <img id="icon" src="../../static/img/radar.png">
    <button id="system" type="button" class="btn btn-primary">AS-P System</button>
    <span id="load_from_Django" class="unselectable">St Mary's Hospital</span>
  </header>
  <div class="bar">
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link active" onclick="toggleBrowseSupplies()">Browse Supplies by Category</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" onclick="toggleViewOrder()">View Orders</a>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Account settings</a>
        <div class="dropdown-menu">
          <a class="dropdown-item" href="#">Change Password</a>
          <a class="dropdown-item" href="#">Change email address</a>
          <a class="dropdown-item" href="#">Change name</a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="#">Log out</a>
        </div>
      </li>
    </ul>
  </div>

  <div class="card text-center">
    <div class="card-header">
      Cart
    </div>
    <div class="card-body">
      <h5 class="card-title">Your cart was empty</h5>
    </div>
    <div class="card-footer text-muted">
      Weight = <span id="weight">0</span> KG
    </div>
  </div>

  <div id="selector">
    <select class="selectpicker" id="selector-inner" data-live-search="true" data-width="50%" onchange="requestCategory()">
      {% if categories %}
        <option>Please select a category...</option>
        {% for category in categories %}
        <option>{{ category.category }}</option>
        {% endfor %}
      {% endif %}
    </select>
  </div>

  <table id="maincontent" class="table">
    {% include 'CM/category_load.html' %}
  </table>

  <div class="viewOrder">
    {% block category %}
    {% endblock %}
  </div>
</body>
<script type="text/javascript">
    var items =  null;
    var cart = [];
    var total_weight = 0;

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    function requestCategory(){
      var csrftoken = Cookies.get('csrftoken');

      $.ajaxSetup({
          beforeSend: function(xhr, settings) {
              if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                  xhr.setRequestHeader("X-CSRFToken", csrftoken);
              }
          }
      });

      var e = document.getElementById("selector-inner");
      var strUser = e.options[e.selectedIndex].text;
      if (strUser != "Please select a category...") {
        $.ajax({
              type: "POST",
              url: "./displayByCategory/",
              data: {
                category : strUser
              },
              success: function (respond) {
                  $('#maincontent').html(respond);
                  $('#maincontent').show();
                  $.ajax({
                        type: "POST",
                        url: "./displayByCategoryJson/",
                        data: {
                          category : strUser
                        },
                        success: function (respond) {
                          window.items = respond;
                      }
                    }
                  );
              }
            }
          );
        } else {
          $('#maincontent').hide();
        }
    }

    function strip(num, precision = 4) {
      return +parseFloat(num.toPrecision(precision));
    }

    function updateWeight(){
        total_weight = 0;
        for (item in cart){
          total_weight += item['quantity'] * item['weight'];
        }
        $('#weight').text(total_weight);
    }

    function checkboxToggle(element){
        if ($(element).prop("checked") == true) {
            var quantity = $(element).parent().siblings('.category_quantity_parent').children()[0].value;
            var id = $(element).parent().siblings('.category_id_parent').html();
            var weight = 0;
            for (item in items){
              // if (item.id == id){
              //     weight = item.weight;
              // }
              console.log(item['weight']);
            }
            let cart_item = {
                item_id: id,
                quantity: quantity,
                weight: weight,
            };
            cart.push(cart_item);
            updateWeight();
        } else {
            var id = $(element).parent().siblings('.category_id_parent').html();
            for (let i = 0; i < cart.length; i++) {
                if (cart[i].item_id == id) {
                    cart.splice(i, 1);
                }
            }
            updateWeight();
        }
        // var selected_itemweight = strip($(element).parent().siblings('.category_quantity_parent').children()[0].name *
        // $(element).parent().siblings('.category_quantity_parent').children()[0].value);
        // var result = $('#weight').val().replace(/^0+/, '') - selected_itemweight;
        // $('#weight').val(result);
        // $('#weight').html(result);
    }
</script>
</html>
<footer>
  <div>Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0"
      target="_blank">CC 3.0 BY</a></div>
</footer>
